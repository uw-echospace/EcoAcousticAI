name: Model Run to Manila Mount

on:
  schedule:
    - cron: '0 16 * * 1'  # 8 AM PT (16:00 UTC) every Monday - Unshelve instance
    - cron: '0 2 * * 2'   # 6 PM PT (02:00 UTC Tuesday) - Shelve instance
  workflow_dispatch:  # Allows manual trigger

jobs:
  unshelve-and-run-model:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 16 * * 1' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Install OpenStack CLI
        run: sudo apt update && sudo apt install -y python3-openstackclient

      - name: Authenticate with OpenStack
        run: |
          mkdir -p ~/.config/openstack
          echo "${{ secrets.CLOUDS_YAML }}" > ~/.config/openstack/clouds.yaml
          chmod 600 ~/.config/openstack/clouds.yaml
          openstack --os-cloud=BIO230143_IU server list  # Debug check

      - name: Unshelve the Instance
        run: |
          INSTANCE_ID="2e41f703-6464-499f-8faf-6412fcfcd8cc"
          STATUS=$(openstack --os-cloud=BIO230143_IU server show $INSTANCE_ID -f value -c status)
          
          if [[ "$STATUS" == "SHELVED_OFFLOADED" ]]; then
            echo "Instance is shelved. Unshelving now..."
            openstack --os-cloud=BIO230143_IU server unshelve $INSTANCE_ID
          fi

          echo "Waiting for the instance to become ACTIVE..."
          for i in {1..10}; do  # Wait up to 10 minutes
            STATUS=$(openstack --os-cloud=BIO230143_IU server show $INSTANCE_ID -f value -c status)
            if [[ "$STATUS" == "ACTIVE" ]]; then
              echo "Instance is now ACTIVE!"
              exit 0
            fi
            echo "Instance is still $STATUS. Waiting 60 seconds..."
            sleep 60
          done

          echo "Instance failed to become ACTIVE within 10 minutes."
          exit 1  # Force GitHub Actions to fail if unshelving takes too long


      - name: Start Instance
        run: |
          INSTANCE_ID="2e41f703-6464-499f-8faf-6412fcfcd8cc"
          STATUS=$(openstack --os-cloud=BIO230143_IU server show $INSTANCE_ID -f value -c status)
          if [[ "$STATUS" == "ACTIVE" ]]; then
            echo "Instance is already active."
          else
            echo "Starting instance..."
            openstack --os-cloud=BIO230143_IU server start $INSTANCE_ID
          fi
         

      - name: Set Up SSH Key
        run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.JETSTREAM2_SSH_KEY }}" > ~/.ssh/jetstream2_key
              chmod 600 ~/.ssh/jetstream2_key
              ssh-keyscan -H "149.165.170.20" >> ~/.ssh/known_hosts      

      - name: Mount Manila Storage
        run:  |
          SSH_KEY=$HOME/.ssh/jetstream2_key
          ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" ubuntu@149.165.170.20 << EOF
          
          ACCESS_KEY="${{ secrets.ACCESS_KEY }}"
          FILE_PATH="/etc/ceph/ceph.client.ecoacousticaccess.keyring"
  
          # Create the keyring file with the access key
          echo "[client.ecoacousticaccess]" | sudo tee $FILE_PATH > /dev/null
          echo "    key = $ACCESS_KEY" | sudo tee -a $FILE_PATH > /dev/null
  
          # Set the file permissions to be read and write for the owner only
          sudo chmod 600 $FILE_PATH
  
          # Verify the permissions (optional)
          ls -l $FILE_PATH
          #cat /etc/ceph/ceph.client.ecoacousticaccess.keyring

            # Define variables for the mount path and access details
            ACCESS_TO="ecoacousticaccess"  # Replace with your access key name
            sudo mkdir -p /mnt/ecoacoustic-storage/
            pwd
            MOUNT_PATH="/mnt/ecoacoustic-storage/"
            CEPH_PATH="149.165.158.38:6789,149.165.158.22:6789,149.165.158.54:6789,149.165.158.70:6789,149.165.158.86:6789:/volumes/_nogroup/b726fc5b-0674-4ba8-a5c4-17a8684d0415/daf825a1-77fa-4c9e-8f5a-c56ed8f7d55c" 

            # Add entry to /etc/fstab to mount the storage on boot
            echo "$CEPH_PATH $MOUNT_PATH ceph name=$ACCESS_TO,x-systemd.device-timeout=30,x-systemd.mount-timeout=30,noatime,_netdev,rw 0 2" | sudo tee -a /etc/fstab > /dev/null

            # Verify the entry is added (optional)
            cat /etc/fstab
            sudo mount -a
            df -h | grep vol
            
            ls -ld /mnt/ecoacoustic-storage/

            pwd
            cd ./EcoAcousticAI/
            git pull 
    
            docker build -t bat-detect-msds -f ./bat-detect-msds/Dockerfile .

            cd buzzfindr/
            docker build -t buzzfindr-image .

            cd ..

            # Step 2: Install rclone and configure it for OSN access
      
          sudo apt-get update
          sudo apt-get install -y rclone
          mkdir -p ~/.config/rclone
          echo "[osn_sdsc_ubna]" > ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Ceph" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = " >> ~/.config/rclone/rclone.conf  # Leave blank for public access
          echo "secret_access_key = " >> ~/.config/rclone/rclone.conf  # Leave blank for public access
          echo "endpoint = https://sdsc.osn.xsede.org" >> ~/.config/rclone/rclone.conf
          echo "no_check_bucket = true" >> ~/.config/rclone/rclone.conf

      # Step 3: Download the latest directory info artifact (if exists)
      - name: Download latest directory info artifact (if exists)
        uses: actions/download-artifact@v4
        with:
          name: latest-directory-artifact
          path: ./latest_directory.txt
        continue-on-error: true  # If the artifact doesn't exist, continue without error

      # Step 4: Check for the most recent directory in the OSN bucket
      - name: Check for most recent directory in OSN bucket
        id: check_data
        run: |
          # List directories in the OSN bucket using rclone
          NEW_DATA=$(rclone lsd osn_sdsc_ubna:bio230143-bucket01 | sort | tail -n 1| awk '{print $NF}')
          echo "Most recent directory: $NEW_DATA"

          # Default latest directory (if no previous directory file exists)
          LAST_PROCESSED_DIRECTORY="ubna_data_04"

          # If previous directory exists in latest_directory.txt, use it
          if [[ -f latest_directory.txt ]]; then
            LAST_PROCESSED_DIRECTORY=$(cat latest_directory.txt)
          fi

          # Compare the most recent directory to the last processed directory
          if [[ "$NEW_DATA" == "$LAST_PROCESSED_DIRECTORY" ]]; then
            echo "No new data found"
            echo "::set-output name=new_data::false"
          else
            echo "New data detected"
            echo "::set-output name=new_data::true"
            echo "::set-output name=new_data_path::osn_sdsc_ubna:bio230143-bucket01/${NEW_DATA}"

            # Update the latest processed directory
            echo "$NEW_DATA" > latest_directory.txt
          fi

      # Step 5: Mount the OSN bucket and process data in Docker
      - name: Mount OSN bucket and process data in Docker
        if: steps.check_data.outputs.new_data == 'true'
        run: |
            SSH_KEY=$HOME/.ssh/jetstream2_key
            ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" ubuntu@149.165.170.20 << EOF
            cd /home/ubuntu/
            mkdir -p /tmp/osn_bucket/
            chmod 777 /tmp/osn_bucket/

            #NEW_DATA=$(rclone lsd osn_sdsc_ubna:bio230143-bucket01 | sort | tail -n 1| awk '{print $NF}')

            sudo sed -i '/^#user_allow_other/s/^#//g' /etc/fuse.conf

            # Step 2: Unmount the existing FUSE filesystem (if mounted)
            #fusermount -u /tmp/osn_bucket/ || true

            echo "after fusermount"

            # Step 3: Mount the FUSE filesystem with rclone using allow_other 
            rclone mount osn_sdsc_ubna:bio230143-bucket01/ubna_data_02/recover-20230622/UBNA_007/ /tmp/osn_bucket/ \
            --vfs-cache-mode off \
            --log-level DEBUG \
            --allow-other \
            --daemon

            echo "mounted"
            sleep 30  # Adjust sleep time as necessary to give rclone time to mount

            pwd
            
            docker run --mount type=bind,source=./EcoAcousticAI/recordings_2023/,target=/app/recordings_buzz/ \
            --mount type=bind,source=./mnt/ecoacoustic-storage/,target=/app/output_buzz/ \ buzzfindr-image:latest

            docker run --rm \
            --mount type=bind,source=./EcoAcousticAI/recordings_2023/,target=/app/recordings_2023/ \
            --mount type=bind,source=./mnt/ecoacoustic-storage/,target=/app/output_dir/ \
            bat-detect-msds:latest python3 /app/bat-detect-msds/src/batdt2_pipeline.py \
            --input_audio='/app/recordings_2023/' \
            --output_directory='/app/output_dir/' --run_model --csv


            ls /mnt/ecoacoustic-storage

            # Clean up (optional, unmount the rclone mount)
            #umount /tmp/osn_bucket/

      - name: Copy Streamlit App to Instance
        if: false
        run: |
          echo "Copying app.py to Jetstream2..."
          SSH_KEY="~/.ssh/jetstream2_key"
          INSTANCE_IP="149.165.170.20"

          scp -o StrictHostKeyChecking=no -i $SSH_KEY app.py ubuntu@$INSTANCE_IP:/home/ubuntu/app.py

      - name: Start Streamlit App
        if: false
        run: |
          echo "Starting Streamlit..."
          SSH_KEY="~/.ssh/jetstream2_key"
          INSTANCE_IP="149.165.170.20"

          ssh -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$INSTANCE_IP << EOF
          echo "Installing Streamlit if not installed..."
          pip3 install --upgrade streamlit pandas

          echo "Launching Streamlit..."
          nohup streamlit run /home/ubuntu/app.py --server.port 8501 --server.enableCORS false --server.enableXsrfProtection false > streamlit.log 2>&1 &
          echo "Streamlit is running in the background."
          EOF


  shelve-instance:
    runs-on: ubuntu-latest
    needs: unshelve-and-run-model  # <-- This makes sure it runs ONLY after the first job completes
    steps:
      - name: Install OpenStack CLI
        run: sudo apt update && sudo apt install -y python3-openstackclient

      - name: Authenticate with OpenStack
        run: |
          mkdir -p ~/.config/openstack
          echo "${{ secrets.CLOUDS_YAML }}" > ~/.config/openstack/clouds.yaml
          chmod 600 ~/.config/openstack/clouds.yaml
          openstack --os-cloud=BIO230143_IU server list  # Debug check

      - name: Shelve Instance
        run: |
          INSTANCE_ID="2e41f703-6464-499f-8faf-6412fcfcd8cc"
          STATUS=$(openstack --os-cloud=BIO230143_IU server show $INSTANCE_ID -f value -c status)

          echo "Checking if instance is ready to be shelved..."
          while [[ "$STATUS" == "BUILD" || "$STATUS" == "REBOOT" || "$STATUS" == "UNSHELVING" ]]; do
            echo "Instance is still transitioning. Waiting 60 seconds..."
            sleep 60
            STATUS=$(openstack --os-cloud=BIO230143_IU server show $INSTANCE_ID -f value -c status)
          done

          if [[ "$STATUS" == "ACTIVE" ]]; then
            echo "Shelving instance now..."
            openstack --os-cloud=BIO230143_IU server shelve $INSTANCE_ID
          else
            echo "Instance is not in a valid state for shelving. Current status: $STATUS"
          fi
